name: Swell Tier 1 Applications Tests (Discover)

on: workflow_call

defaults:
  run:
    shell: bash

jobs:

  # Initialization needed by all the workflows
  # ------------------------------------------
  swell-tier_1-setup:
    uses: ./.github/workflows/setup-swell.yml

  tier_1_matrix:
    strategy:
      matrix:
        suite: ["ufo_testing" "hofx" "3dvar"]
    steps:
      - uses: ./.github/workflows/run-swell-suite.yml
        needs: swell-tier_1-setup
        with:
          suite: ${{ matrix.suite }}

# Perform all the clean up
# ------------------------

  swell-tier_1-clean_up_success:

    runs-on: nccs-discover
    timeout-minutes: 30
    needs: tier_1_matrix

    steps:

      - name: Remove the run directory
        run: |
          rm -r -f /discover/nobackup/gmao_ci/swell/tier1/${GITHUB_RUN_ID}

  swell-tier_1-clean_up_always:

    runs-on: nccs-discover
    timeout-minutes: 30
    needs: tier_1_matrix
    if: always()  # Always run the clean up, even if failed or cancelled

    steps:

      - name: Remove the cylc logging directories
        run: |
          rm -r -f $HOME/cylc-run/swell-ufo_testing-${GITHUB_RUN_ID}-suite
          rm -r -f $HOME/cylc-run/swell-hofx-${GITHUB_RUN_ID}-suite

      - name: Remove the R2D2 experiment output
        run: |
          rm -r -f /discover/nobackup/gmao_ci/R2D2DataStore/Local/ncdiag/ob/swell-hofx-${GITHUB_RUN_ID}
