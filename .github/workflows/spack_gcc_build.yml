name: Spack Build Tests

on:
  workflow_call:
    inputs:
      fixture-repo:
        description: 'Repository to checkout (e.g., GEOS-ESM/GEOSgcm). If not provided, uses current repo'
        required: false
        type: string
        default: ''

      fixture-ref:
        description: 'Repository ref/branch to checkout (only used when fixture-repo is provided)'
        required: false
        type: string
        default: ''

      use-esmf-develop:
        description: 'Use ESMF develop branch instead of stable release'
        required: false
        type: boolean
        default: false

      run-mepo-develop:
        description: 'Whether to run mepo develop step'
        required: false
        type: boolean
        default: true

      run-tests:
        description: 'Whether to build and run tests'
        required: false
        type: boolean
        default: false

      patch-esmf:
        description: 'Whether to patch ESMF package for 9.0.0b03 version'
        required: false
        type: boolean
        default: false

    secrets:
      BUILDCACHE_USERNAME:
        description: 'Buildcache username'
        required: true
      BUILDCACHE_TOKEN:
        description: 'Buildcache token'
        required: true

jobs:
  build_gcm:
    name: Spack Build (${{ inputs.use-esmf-develop && 'ESMF develop' || 'ESMF stable' }})
    runs-on: ubuntu-24.04
    steps:

      - name: Checkout repository
        uses: actions/checkout@v5
        with:
          fetch-depth: 1
          filter: blob:none
          repository: ${{ inputs.fixture-repo || null }}
          ref: ${{ inputs.fixture-ref || null }}

      - name: Set all directories as git safe
        run: |
          git config --global --add safe.directory '*'

      - name: Setup Python
        uses: actions/setup-python@v5
        with:
          python-version: '3.13'

      - name: Pip install mepo
        run: |
          python -m pip install --upgrade pip
          pip install mepo
          mepo --version

      - name: Mepo clone external repos
        run: |
          mepo clone --partial blobless
          mepo status

      - name: Mepo develop usual suspects
        if: ${{ inputs.run-mepo-develop }}
        run: |
          mepo develop GEOSgcm_GridComp GEOSgcm_App GMAO_Shared GEOS_Util
          mepo status

      - name: Debug PR branch
        run: echo "PR is coming from ${{ github.event.pull_request.head.ref }}"

      - name: Update other branches
        if: ${{ github.event.pull_request.head.ref != 'main' && github.event.pull_request.head.ref != 'develop' }}
        run: |
          mepo checkout-if-exists ${GITHUB_HEAD_REF}
          mepo status

      - name: Set up Spack
        uses: spack/setup-spack@v2
        with:
          ref: develop
          color: true
          path: spack
          buildcache: false

      - name: Patch ESMF package for 9.0.0b03
        if: ${{ inputs.patch-esmf }}
        shell: spack-bash {0}
        run: |
          # Use spack to find where the esmf package is located
          ESMF_PKG_PATH=$(spack location -p esmf 2>/dev/null || echo "")

          if [ -n "$ESMF_PKG_PATH" ] && [ -d "$ESMF_PKG_PATH" ]; then
            # Location is a directory, so find package.py inside it
            ESMF_PKG_PATH="${ESMF_PKG_PATH}/package.py"
          fi

          if [ -n "$ESMF_PKG_PATH" ] && [ -f "$ESMF_PKG_PATH" ]; then
            echo "Found ESMF package at: $ESMF_PKG_PATH"

            # Check if version already exists
            if ! grep -q "9.0.0b03" "$ESMF_PKG_PATH"; then
              sed -i '/# generate chksum with/a \    version("9.0.0b03", tag="v9.0.0b03")' "$ESMF_PKG_PATH"
              echo "Successfully added ESMF 9.0.0b03 version"
            else
              echo "ESMF 9.0.0b03 version already exists"
            fi
          else
            echo "ERROR: Could not find ESMF package.py file"
            # Debug information
            echo "Debug: looking for esmf package.py files:"
            find . -name "package.py" | grep -i esmf || echo "No files found"
            exit 1
          fi

      - name: Find compilers
        shell: spack-bash {0}
        run: |
          spack compiler find

      - name: Set default compiler and target
        shell: spack-bash {0}
        run: |
          spack config add 'packages:all:require:target=x86_64_v3'

      - name: Create Spack environment
        shell: spack-bash {0}
        run: |
          spack env create spack-env
          spack env activate spack-env

      - name: Login (standard buildcache)
        if: ${{ !inputs.patch-esmf }}
        shell: spack-bash {0}
        run: |
          spack -e spack-env mirror add geos-buildcache oci://ghcr.io/GEOS-ESM/geos-buildcache
          spack -e spack-env mirror set --oci-username-variable "${{ secrets.BUILDCACHE_USERNAME }}" --oci-password-variable "${{ secrets.BUILDCACHE_TOKEN }}" geos-buildcache
          spack -e spack-env mirror list
          spack -e spack-env buildcache list --allarch

      - name: Login (ESMF9 buildcache)
        if: ${{ inputs.patch-esmf }}
        shell: spack-bash {0}
        run: |
          # NOTE: We use a different buildcache for ESMF9 builds since I couldn't figure out
          # how to get the the original buildcache to work with two different esmf versions
          spack -e spack-env mirror add geos-buildcache-esmf9 oci://ghcr.io/GEOS-ESM/geos-buildcache-esmf9
          spack -e spack-env mirror set --oci-username-variable "${{ secrets.BUILDCACHE_USERNAME }}" --oci-password-variable "${{ secrets.BUILDCACHE_TOKEN }}" geos-buildcache-esmf9
          spack -e spack-env mirror list
          spack -e spack-env buildcache list --allarch

      - name: Concretize
        shell: spack-bash {0}
        run: |
          spack -e spack-env concretize

      - name: Install all dependencies (stable ESMF)
        if: ${{ !inputs.use-esmf-develop }}
        shell: spack-bash {0}
        run: |
          spack clean -m
          spack -e spack-env install --add --no-check-signature --use-buildcache only \
            esmf gftl gftl-shared fargparse pflogger pfunit yafyaml ecbuild udunits openblas fms

      - name: Install dependencies (ESMF develop)
        if: ${{ inputs.use-esmf-develop }}
        shell: spack-bash {0}
        run: |
          spack clean -m
          spack -e spack-env install --add --no-check-signature --use-buildcache only \
            openmpi parallelio py-pyyaml python netcdf-fortran netcdf-c hdf5 \
            gftl gftl-shared fargparse pflogger pfunit yafyaml ecbuild udunits openblas fms

      - name: Install ESMF develop
        if: ${{ inputs.use-esmf-develop }}
        shell: spack-bash {0}
        run: |
          spack -e spack-env install --add --no-check-signature esmf@develop

      - name: Build with CMake
        shell: spack-bash {0}
        run: |
          spack env activate spack-env
          spack load \
            ${{ inputs.use-esmf-develop && 'esmf@develop' || 'esmf' }} \
            gftl gftl-shared fargparse pflogger pfunit yafyaml ecbuild udunits openblas
          spack find --loaded
          FC=gfortran-14 CC=gcc-14 CXX=g++-14
          cmake -B build -S . \
            -DCMAKE_INSTALL_PREFIX=$PWD/install \
            -DCMAKE_BUILD_TYPE=Debug \
            -DUSE_F2PY=OFF \
            -DCMAKE_Fortran_COMPILER=${FC} \
            -DCMAKE_C_COMPILER=${CC} \
            -DCMAKE_CXX_COMPILER=${CXX}
          cmake --build build -j 4
          cmake --install build

      - name: Build and run tests
        if: ${{ inputs.run-tests }}
        shell: spack-bash {0}
        run: |
          spack env activate spack-env
          cmake --build build --target tests -j 4
