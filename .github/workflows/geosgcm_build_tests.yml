name: GEOS-ESM Fixture Build Tests

on:
  workflow_call:
    inputs:
      compiler:
        description: 'Compiler to use (ifort, ifx, gfortran-14, gfortran-15)'
        required: false
        type: string
        default: 'ifort'

      cmake-build-type:
        description: 'CMake build type'
        required: false
        type: string
        default: 'Debug'

      baselibs-version:
        description: 'Container version to use (e.g., v8.20.0, v9.0.0)'
        required: false
        type: string
        default: 'v8.20.0'

      fixture-repo:
        description: 'Repository to checkout (e.g., GEOS-ESM/GEOSgcm). If not provided, uses current repo'
        required: false
        type: string
        default: ''

      fixture-ref:
        description: 'Repository ref/branch to checkout (only used when fixture-repo is provided)'
        required: false
        type: string
        default: ''

      run-mepo-develop:
        description: 'Whether to run mepo develop step'
        required: false
        type: boolean
        default: true

      build-jobs:
        description: 'Number of parallel build jobs'
        required: false
        type: number
        default: 4

      build-target:
        description: "Target for CMake to build"
        required: false
        type: string
        default: ''

jobs:
  setup:
    runs-on: ubuntu-latest
    outputs:
      container-image: ${{ steps.config.outputs.container-image }}
      fortran-compiler: ${{ steps.config.outputs.fortran-compiler }}
      version-command: ${{ steps.config.outputs.version-command }}
      repo-name: ${{ steps.config.outputs.repo-name }}
    steps:
      - name: Configure compiler settings
        id: config
        run: |
          VERSION="${{ inputs.baselibs-version }}"
          case "${{ inputs.compiler }}" in
            "ifort")
              echo "container-image=gmao/ubuntu24-geos-env:${VERSION}-intelmpi_2021.13-ifort_2021.13" >> $GITHUB_OUTPUT
              echo "fortran-compiler=ifort" >> $GITHUB_OUTPUT
              echo "version-command=ifort --version" >> $GITHUB_OUTPUT
              ;;
            "ifx")
              echo "container-image=gmao/ubuntu24-geos-env:${VERSION}-intelmpi_2021.16-ifx_2025.2" >> $GITHUB_OUTPUT
              echo "fortran-compiler=ifx" >> $GITHUB_OUTPUT
              echo "version-command=ifx --version" >> $GITHUB_OUTPUT
              ;;
            "gfortran-14")
              echo "container-image=gmao/ubuntu24-geos-env-mkl:${VERSION}-openmpi_5.0.5-gcc_14.2.0" >> $GITHUB_OUTPUT
              echo "fortran-compiler=gfortran" >> $GITHUB_OUTPUT
              echo "version-command=gfortran --version" >> $GITHUB_OUTPUT
              ;;
            "gfortran-15")
              echo "container-image=gmao/ubuntu24-geos-env-mkl:${VERSION}-openmpi_5.0.5-gcc_15.2.0" >> $GITHUB_OUTPUT
              echo "fortran-compiler=gfortran" >> $GITHUB_OUTPUT
              echo "version-command=gfortran --version" >> $GITHUB_OUTPUT
              ;;
            *)
              echo "::error::Unsupported compiler: ${{ inputs.compiler }}"
              exit 1
              ;;
          esac
      - name: Extract repository name
        id: repo-name
        run: |
          if [[ -n "${{ inputs.fixture-repo }}" ]]; then
            # Extract repo name from fixture-repo (e.g., GEOS-ESM/GEOSldas -> GEOSldas)
            REPO_NAME=$(basename "${{ inputs.fixture-repo }}")
          else
            # Fall back to current repository name
            REPO_NAME=$(basename "${{ github.repository }}")
          fi
          echo "repo-name=${REPO_NAME}" >> $GITHUB_OUTPUT
          echo "Using repository name: ${REPO_NAME}"

  build_fixture:
    name: Build ${{ inputs.fixture-repo || github.repository }} (${{ inputs.compiler }})
    needs: setup
    if: "!contains(github.event.pull_request.labels.*.name, '0 diff trivial')"
    runs-on: ubuntu-latest
    container:
      image: ${{ needs.setup.outputs.container-image }}

    env:
      OMPI_ALLOW_RUN_AS_ROOT: 1
      OMPI_ALLOW_RUN_AS_ROOT_CONFIRM: 1
      OMPI_MCA_btl_vader_single_copy_mechanism: none

    steps:
      - name: Free Disk Space
        run: |
          echo "Before cleanup:"
          df -h

          # Remove large packages
          rm -rf /usr/share/dotnet
          rm -rf /usr/local/lib/android
          rm -rf /opt/ghc
          rm -rf /opt/hostedtoolcache/CodeQL
          rm -rf /usr/local/share/boost
          rm -rf "$AGENT_TOOLSDIRECTORY"

          # Remove Docker images (if you don't need them)
          docker rmi $(docker image ls -aq) || true

          # Clean apt cache
          apt-get clean

          echo "After cleanup:"
          df -h

      - name: Checkout GCM
        uses: actions/checkout@v5
        with:
          fetch-depth: 1
          filter: blob:none
          repository: ${{ inputs.fixture-repo || null }}
          ref: ${{ inputs.fixture-ref || null }}

      - name: Set all directories as git safe
        run: |
          git config --global --add safe.directory '*'

      - name: Versions etc.
        run: |
          ${{ needs.setup.outputs.version-command }}
          mpirun --version
          echo $BASEDIR

      - name: Try matching branch in ${{ needs.setup.outputs.repo-name }} fixture
        if: ${{ github.event.pull_request.head.ref != 'main' && github.event.pull_request.head.ref != 'develop' }}
        run: |
          BRANCH="${GITHUB_HEAD_REF}"
          # Fetch the branch if it exists
          if git fetch origin "$BRANCH" 2>/dev/null; then
            echo "✓ Found matching branch '$BRANCH' in ${{ needs.setup.outputs.repo-name }} fixture"
            git checkout "$BRANCH"
          else
            echo "ℹ No matching branch '$BRANCH' in ${{ needs.setup.outputs.repo-name }} fixture, using default branch"
          fi
          git branch

      - name: Mepo clone external repos
        run: |
          mepo clone --partial blobless
          mepo status

      - name: Mepo develop usual suspects
        if: ${{ inputs.run-mepo-develop }}
        run: |
          mepo develop GEOSgcm_GridComp GEOSgcm_App GMAO_Shared GEOS_Util
          mepo status

      - name: Debug PR branch
        run: echo "PR is coming from ${{ github.event.pull_request.head.ref }}"

      - name: Update other branches
        if: ${{ github.event.pull_request.head.ref != 'main' && github.event.pull_request.head.ref != 'develop' }}
        run: |
          mepo checkout-if-exists ${GITHUB_HEAD_REF}
          mepo status

      - name: CMake
        run: |
          cmake -B build -S . --install-prefix=$PWD/install \
            -DCMAKE_Fortran_COMPILER=${{ needs.setup.outputs.fortran-compiler }} \
            -DCMAKE_BUILD_TYPE=${{ inputs.cmake-build-type }} \
            -DMPIEXEC_PREFLAGS='--oversubscribe' \
            -DUSE_F2PY=OFF

      - name: Build
        run: |
          cmake --build build -j ${{ inputs.build-jobs }} ${{ inputs.build-target }}

      # For now we do not install. For unknown reasons, MAPL3 + ifort causes the
      # install step to not fail, but also not complete. It just "halts" forever.
      # And GitHub doesn't even see this as a "real" error so continue-on-error doesn
      # not help. But, for CI, the build is the important part anyway.
      #############################
      # - name: Install           #
      #   run: |                  #
      #     cmake --install build #
      #############################
