name: Swell Tier 2 Applications Tests (Discover)

on: workflow_call

defaults:
  run:
    shell: bash

jobs:

  # Initialization needed by all the workflows
  # ------------------------------------------
  swell-tier_2-setup:
    uses: ./.github/workflows/setup-swell.yml
    with:
      tier: "tier2"
  # --------------------------------------------
  # STEP1: BUILD JEDI CODE FROM DEVELOP BRANCHES
  # --------------------------------------------

  swell-tier_2-build_jedi:
    needs: swell-tier_2-setup
    uses: ./.github/workflows/run-swell-suite.yml
    with:
      tier: "tier2"
      suite: "build_jedi"

  # ----------------------------------------
  # STEP2: RUN TESTING SUITES WITH NEW BUILD
  # ----------------------------------------

  # Run ncdiag convesion suite
  swell-tier_2-convert_ncdiags:
    needs: swell-tier_2-build_jedi
    uses: ./.github/workflows/run-swell-suite.yml
    with:
      suite: "convert_ncdiags"
      tier: "tier2"

  # Run ufo_testing suite
  swell-tier_2-ufo_testing:
    needs: swell-tier_2-build_jedi
    uses: ./.github/workflows/run-swell-suite.yml
    with:
      suite: "ufo_testing"
      tier: "tier2"

  # Run hofx suite
  swell-tier_2-hofx:
    needs: swell-tier_2-build_jedi
    uses: ./.github/workflows/run-swell-suite.yml
    with:
      suite: "hofx"
      tier: "tier2"

  # -------------------------------------------------------------
  # STEP3: PERFORM UPDATES OF STABLE NIGHTLY POINTER AND CLEAN UP
  # -------------------------------------------------------------

  # Update the nightly pointer (only runs if tier 1 tests were sucessful)
  # --------------------------
  swell-tier_2-update_if_stable:

    runs-on: nccs-discover
    timeout-minutes: 30
    needs: [swell-tier_2-convert_ncdiags, swell-tier_2-ufo_testing, swell-tier_2-hofx]

    steps:
      - name: Replace link to stable with link to current run and remove old directory
        run: |
          # Get full path to previous sucessful run
          previous_stable=`readlink -f /discover/nobackup/gmao_ci/swell/tier2/stable`

          # Remove link
          rm -f /discover/nobackup/gmao_ci/swell/tier2/stable

          # Link to new stable
          ln -sf /discover/nobackup/gmao_ci/swell/tier2/${GITHUB_RUN_ID} /discover/nobackup/gmao_ci/swell/tier2/stable

          # Remove old stable
          echo "Removing previous stable: $previous_stable"
          rm -r -f $previous_stable

      # Remove the running lock if the update was sucessful
      - name: Remove the running lock
        run: |
          rm -f /discover/nobackup/gmao_ci/swell/tier2/__running__

  # Perform all the clean up (always runs regardless of success of failure)
  # ------------------------

  swell-tier_2-clean_up:

    runs-on: nccs-discover
    timeout-minutes: 30
    needs: [swell-tier_2-convert_ncdiags, swell-tier_2-ufo_testing, swell-tier_2-hofx]
    if: always()  # Always run the clean up, even if failed or cancelled

    steps:

      - name: Remove the cylc logging directories
        run: |
          rm -r -f $HOME/cylc-run/swell-convert_ncdiags-${GITHUB_RUN_ID}-suite
          rm -r -f $HOME/cylc-run/swell-ufo_testing-${GITHUB_RUN_ID}-suite
          rm -r -f $HOME/cylc-run/swell-hofx-${GITHUB_RUN_ID}-suite
          rm -r -f $HOME/cylc-run/swell-build_jedi-${GITHUB_RUN_ID}-suite

      - name: Remove the R2D2 experiment output
        run: |
          rm -r -f /discover/nobackup/gmao_ci/R2D2DataStore/Local/ncdiag/ob/swell-hofx-${GITHUB_RUN_ID}
