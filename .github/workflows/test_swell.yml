name: Swell Tier 1 Applications Tests (Discover)

on: workflow_call

defaults:
  run:
    shell: bash

env:
  CI_BASE: /discover/nobackup/gmao_ci/swell/tier1

jobs:
  # Define the suite list once
  define-matrix:
    runs-on: nccs-discover
    outputs:
      suites: ${{ steps.set-suites.outputs.suites }}
      suites_space: ${{ steps.set-suites.outputs.suites_space }}
    steps:
      - name: Set suite list
        id: set-suites
        run: |
          SUITES='["3dvar_cycle", "3dfgat_cycle", "hofx", "3dvar", "3dvar_atmos", "3dfgat_atmos", "localensembleda"]'
          echo "suites=$SUITES" >> $GITHUB_OUTPUT
          echo "suites_space=3dvar_cycle 3dfgat_cycle hofx 3dvar 3dvar_atmos 3dfgat_atmos localensembleda" >> $GITHUB_OUTPUT

  # Initialization needed by all the workflows
  swell-tier_1-setup:
    runs-on: nccs-discover
    timeout-minutes: 30
    needs: define-matrix
    steps:
      - name: validate-workflow
        run: /home/jardizzo/bin/nams_check.py ${{ github.triggering_actor }} swell

      - name: acquire-swell
        uses: actions/checkout@v3

      - name: install-swell
        run: |
          mkdir ${{ env.CI_BASE }}/${GITHUB_RUN_ID}
          cp ${GITHUB_WORKSPACE}/src/swell/deployment/platforms/nccs_discover_sles15/modules ${{ env.CI_BASE }}/${GITHUB_RUN_ID}/
          source ${{ env.CI_BASE }}/${GITHUB_RUN_ID}/modules
          pip install --prefix=${{ env.CI_BASE }}/${GITHUB_RUN_ID}/swell -r ${GITHUB_WORKSPACE}/requirements.txt --no-cache-dir ${GITHUB_WORKSPACE}

  # Run all test workflows using matrix
  swell-tier_1-test:
    runs-on: nccs-discover
    timeout-minutes: 600
    needs: [define-matrix, swell-tier_1-setup]
    strategy:
      fail-fast: false
      matrix:
        suite: ${{ fromJson(needs.define-matrix.outputs.suites) }}

    steps:
      - name: run-swell-${{ matrix.suite }}
        run: |
          CI_WORKSPACE=${{ env.CI_BASE }}/${GITHUB_RUN_ID}
          SUITE_NAME=${{ matrix.suite }}
          CI_WORKSPACE_JOB=${CI_WORKSPACE}/${SUITE_NAME}
          EXPERIMENT_ID=swell-${SUITE_NAME}-${GITHUB_RUN_ID}

          mkdir -p $CI_WORKSPACE_JOB
          source ${CI_WORKSPACE}/modules

          PYVER=$(python --version | awk '{print $2}' | awk -F. '{print $1"."$2}')
          export PATH=$CI_WORKSPACE/swell/bin:$PATH
          export PYTHONPATH=${PYTHONPATH}:$CI_WORKSPACE/swell/lib/python$PYVER/site-packages

          cat > $CI_WORKSPACE_JOB/${SUITE_NAME}-override.yaml <<EOF
          experiment_id: $EXPERIMENT_ID
          experiment_root: $CI_WORKSPACE_JOB
          EOF

          rm -rf $HOME/cylc-run/${EXPERIMENT_ID}-suite

          cd $CI_WORKSPACE_JOB
          swell create ${SUITE_NAME} -m defaults -p nccs_discover_sles15 -o $CI_WORKSPACE_JOB/${SUITE_NAME}-override.yaml
          swell launch $CI_WORKSPACE_JOB/${EXPERIMENT_ID}/${EXPERIMENT_ID}-suite --no-detach --log_path $CI_WORKSPACE_JOB/${EXPERIMENT_ID}

      - name: Mark failed on failure
        if: failure()
        run: |
          CI_WORKSPACE_JOB=${{ env.CI_BASE }}/${GITHUB_RUN_ID}/${{ matrix.suite }}
          mv $CI_WORKSPACE_JOB ${CI_WORKSPACE_JOB}_FAILED || true

  # Cleanup on success
  swell-tier_1-clean_up_success:
    runs-on: nccs-discover
    timeout-minutes: 30
    needs: [define-matrix, swell-tier_1-test]
    steps:
      - name: Remove the run directory
        run: rm -rf ${{ env.CI_BASE }}/${GITHUB_RUN_ID}

  # Cleanup always (cylc logs and R2D2)
  swell-tier_1-clean_up_always:
    runs-on: nccs-discover
    timeout-minutes: 30
    needs: [define-matrix, swell-tier_1-test]
    if: always()
    steps:
      - name: Remove cylc logging directories
        run: |
          for suite in ${{ needs.define-matrix.outputs.suites_space }}; do
            rm -rf $HOME/cylc-run/swell-${suite}-${GITHUB_RUN_ID}-suite
          done

      - name: Remove R2D2 experiment output
        run: |
          for suite in ${{ needs.define-matrix.outputs.suites_space }}; do
            rm -rf /discover/nobackup/gmao_ci/R2D2DataStore/Local/ncdiag/ob/swell-${suite}-${GITHUB_RUN_ID}
          done
